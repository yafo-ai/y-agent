import{r as c,l as X,aR as Ye,z as _,K as q,R as a,B as s,J as i,u as r,al as f,ar as ce,L as h,S as _e,D as x,O as v,E as pe,Q as k,aS as He,A as u,a6 as S,W as O,P as g,I as G}from"./vue-CdYMfVVj.js";import{_ as Ie,P as We,l as j,u as Ae,Q as Fe,R as Ke,i as Pe,S as Qe}from"./index-B6WbZO8q.js";import{a as fe}from"./comp-ClzPtuSi.js";import{r as Je}from"./result-CcYZ99eM.js";import{i as ve}from"./ioinput-6Hhi5G6f.js";import{C as Z}from"./element-GwJlJi_X.js";import"./editor-Dhn2M38E.js";const Xe={style:{height:"100%"}},Ge={class:"c-top-searchbox c-js-item"},Ze={class:"s-origonbox"},et={style:{display:"inline-flex",width:"200px"}},tt={class:"flowlist"},lt={style:{margin:"0 16px"}},ot={key:0,class:"c-tips"},at=["onClick"],st={style:{display:"inline-flex",width:"200px"}},nt={class:"flowlist"},it={style:{margin:"0 16px"}},rt={key:0,class:"c-tips"},ut=["onClick"],dt={class:"flex"},ct=["title"],_t={class:"item"},pt={class:"rbox"},ft={class:"pagelistbox"},vt={class:"c-tablebox tableboxContain c-tooltip"},mt={class:"dotbox"},gt={class:"dotcontentbox c-scroll-contain"},wt={key:0,class:"title"},ht={key:1,class:"items"},yt={class:"item ellipsis"},bt={key:2,class:"title"},xt={key:3,class:"items"},kt={class:"item ellipsis"},Vt={key:4,class:"title"},Ct={key:5,class:"items"},qt={class:"item ellipsis"},St={style:{display:"inline-flex","align-items":"center"}},$t={style:{display:"flex"}},zt={style:{color:"#409eff"}},Tt=["onClick"],Et={class:"c-emptybox"},Dt={key:0,class:"c-pagination"},Ut={class:"treebox"},Mt=["title"],Rt=["title"],Bt={__name:"report",setup(Lt){const w=Ye(),me=He(),ge=Ae(),V=c("");c(!1);const b=c([]),U=c(0);let o=X({page:1,pagesize:30,flow_id:void 0,testname:"",origin:void 0,test_cate_id:void 0});const ee=()=>{V.value="",o.flow_log_id=void 0,o.flow_id=void 0,o.flow_name="",o.source_name="",o.source_id=void 0,o.user_id="",o.testname="",o.test_cate_id=void 0,o.flow_name="",o.conversation_id="",o.question="",o.origin=void 0,o.created_at_start="",o.created_at_end="",b.value=[]};ee(),w.query.flow_log_id&&(o.flow_log_id=parseInt(w.query.flow_log_id)),w.query.created_at_start&&(b.value=[w.query.created_at_start,w.query.created_at_end]);for(let l in w.query)w.query[l]&&(isNaN(w.query[l])?o[l]=w.query[l]:o[l]=parseInt(w.query[l]));let $=c([]);const M=l=>{l=="init"&&(o.page=1),b.value&&b.value.length?(o.created_at_start=b.value[0],o.created_at_end=b.value[1]):(o.created_at_start="",o.created_at_end="");let e={...o};if(e.flow_log_id=e.flow_log_id||0,Fe(e).then(d=>{let p=d.rows||[];p.forEach(N=>{te(N)}),$.value=p,U.value=d.total_records}),l!="noquery"){let d={...w.query,...o};me.replace({path:w.path,query:d})}},we=l=>{let e=-1;$.value.forEach((d,p)=>{d.id==l.id&&(e=p)}),e>-1&&(te(l),$.value.splice(e,1,l))},te=l=>{l.test_cates||(l.test_cates=[]),l.train_cates||(l.train_cates=[]);let e=l.train_cates||[],d=l.test_cates||[];l.node_log&&l.node_log.length>0&&l.node_log.forEach(p=>{e=e.concat(p.cate),d=d.concat(p.unit_cate)}),e=j.uniqBy(e,"cate_id"),d=j.uniqBy(d,"cate_id"),e.forEach(p=>{p.xl=!0}),d.forEach(p=>{p.tag=p.tag||"S"}),l.test_cates=d,l.train_cates=e};M();const le=c({}),Y=c(!1),he=async l=>{le.value=l,Y.value=!0};c(null);const H=c(!1),I=X({top:0,left:0}),z=c(null),oe=c(0),ye=(l,e,d)=>{z.value=l,m.id=z.value.id,m.workflow_log_id=z.value.id,m.answer=z.value.output.join(`
`),m.question=z.value.user_input,m.message_history=[],Ce.value=!0,H.value=!0,I.top=`${d.clientY}px`,I.left=`${d.clientX}px`,oe.value=d.clientY,d.preventDefault()},T=c([{id:0,name:"未分类",color:"#ff0000",pid:null,children:[],tag:"S"},{id:0,name:"未分类",color:"#ff0000",pid:null,children:[],tag:"W"}]),be=c([{id:0,name:"未分类",color:"#ff0000",pid:null,children:[]}]);(()=>{Ke().then(l=>{T.value=[{id:0,name:"未分类",color:"#ff0000",pid:null,children:[],tag:"S"},{id:0,name:"未分类",color:"#ff0000",pid:null,children:[],tag:"W"}].concat(l)}).catch(l=>{})})();const m=X({id:"",workflow_log_id:"",type:"",answer:"",question:"",message_history:""}),W=c(1),xe=l=>{l.target.className!="custom-tree-node"&&se()},A=c(!1),ae=c(!1),se=()=>{H.value=!1,A.value=!1,ae.value=!1},F=(l,e,d)=>{l.forEach(p=>{if(p.id==e)return d&&d(p),!0;p.children&&p.children.length>0&&F(p.children,e,d)})},ke=()=>{$.value.forEach(l=>{l.id==m.id&&(W.value==1?(console.log(T.value),F(T.value.filter(e=>e.tag=="W"),m.type,function(e){l.test_cates.push(e)})):W.value==2&&F(be.value,m.type,function(e){l.train_cates.push(e)}))})},Ve=l=>{if(l===""||l===void 0||l===null)return _this.$message("请选择分类","error"),!1;Qe({cate_id:l,workflow_log_id:m.workflow_log_id,question:m.question,right_answer:m.answer}).then(e=>{e&&(_this.$message("添加成功"),se(),ke())}).catch(e=>{})},Ce=c(!1),qe=l=>l.test_cates.concat(l.train_cates),Se=l=>{m.type=l.id,W.value=1,Ve(l.id)};c(1);const R=c(0),E=c(null),D=c(!1),C=c(!1),K=c(null),P=c(null),B=c([]),L=c([]),ne=c([]),$e=l=>{D.value=!1,o.source_id=void 0,o.source_name="",L.value=l.sources,ne.value=j.cloneDeep(l.sources),o.flow_id=l.flow_id,o.flow_name=l.flow_name,K.value&&K.value.blur()},Q=c([]);We().then(l=>{B.value=l.rows,Q.value=j.cloneDeep(l.rows)});const ie=()=>{D.value=!0,o.flow_id=void 0;let l=[];Q.value.forEach(e=>{e.flow_name.indexOf(o.flow_name)>-1&&l.push(e)}),o.flow_name||(l=Q.value),B.value=l},re=()=>{C.value=!0,o.source_id=void 0;let l=[];ne.value.forEach(e=>{e.source_name.indexOf(o.source_name)>-1&&l.push(e)}),L.value=l},ze=l=>{C.value=!1,o.source_id=l.source_id,o.source_name=l.source_name,P.value&&P.value.blur()};return(l,e)=>{const d=f("el-input"),p=f("el-form-item"),N=f("el-scrollbar"),J=f("el-popover"),Te=f("el-date-picker"),ue=f("el-option"),Ee=f("el-select"),De=f("el-tree-select"),Ue=f("el-form"),de=f("el-button"),y=f("el-table-column"),Me=f("el-tooltip"),Re=f("el-table"),Be=f("el-pagination"),Le=f("el-tree"),Ne=ce("searchOpen"),Oe=ce("initTableHeight");return u(),_(k,null,[q((u(),_("div",Xe,[e[28]||(e[28]=s("div",{class:"c-titlebox"},[s("span",{class:"title"},"流程日志")],-1)),s("div",Ge,[a(Ue,{model:r(o),ref:"searchFormRef",inline:"",class:"demo-form-inline"},{default:i(()=>[a(p,{label:"id",prop:"flow_log_id"},{default:i(()=>[a(d,{clearable:"",modelValue:r(o).flow_log_id,"onUpdate:modelValue":e[0]||(e[0]=t=>r(o).flow_log_id=t),type:"text"},null,8,["modelValue"])]),_:1}),a(p,{label:"用户ID",prop:"user_id"},{default:i(()=>[a(d,{clearable:"",modelValue:r(o).user_id,"onUpdate:modelValue":e[1]||(e[1]=t=>r(o).user_id=t),type:"text"},null,8,["modelValue"])]),_:1}),a(p,{label:"窗口id",prop:"conversation_id"},{default:i(()=>[a(d,{clearable:"",modelValue:r(o).conversation_id,"onUpdate:modelValue":e[2]||(e[2]=t=>r(o).conversation_id=t),type:"text"},null,8,["modelValue"])]),_:1}),a(p,{label:"输入",prop:"question"},{default:i(()=>[a(d,{clearable:"",modelValue:r(o).question,"onUpdate:modelValue":e[3]||(e[3]=t=>r(o).question=t),type:"text"},null,8,["modelValue"])]),_:1}),a(p,{label:"流程",prop:"flow_name"},{default:i(()=>[s("div",Ze,[q((u(),_("div",et,[a(J,{visible:D.value,placement:"bottom",width:200},{reference:i(()=>[a(d,{onClick:e[4]||(e[4]=O(()=>{},["stop"])),onFocus:e[5]||(e[5]=t=>{D.value=!0,ie()}),ref_key:"flow_nameref",ref:K,onKeyup:ie,placeholder:"搜索流程",style:{width:"200px"},modelValue:r(o).flow_name,"onUpdate:modelValue":e[6]||(e[6]=t=>r(o).flow_name=t),type:"text"},null,8,["modelValue"])]),default:i(()=>[s("div",tt,[a(N,{"max-height":400},{default:i(()=>[s("div",lt,[B.value.length<1?(u(),_("div",ot,"暂无流程")):h("",!0),(u(!0),_(k,null,S(B.value,t=>(u(),_("div",{onClick:O(n=>$e(t),["stop"]),class:"item"},g(t.flow_name),9,at))),256))])]),_:1})])]),_:1},8,["visible"])])),[[r(Z),()=>{D.value=!1}]]),q((u(),_("div",st,[a(J,{visible:C.value,placement:"bottom",width:200},{reference:i(()=>[a(d,{placeholder:"搜索来源",ref_key:"flow_nameref1",ref:P,style:{width:"200px"},onClick:e[7]||(e[7]=O(()=>{},["stop"])),onFocus:e[8]||(e[8]=t=>{C.value=!0,re()}),onBlur:e[9]||(e[9]=t=>{C.value=!1}),onKeyup:re,modelValue:r(o).source_name,"onUpdate:modelValue":e[10]||(e[10]=t=>r(o).source_name=t),type:"text"},null,8,["modelValue"])]),default:i(()=>[s("div",nt,[a(N,{"max-height":400},{default:i(()=>[s("div",it,[L.value.length<1?(u(),_("div",rt,"暂无来源")):h("",!0),(u(!0),_(k,null,S(L.value,t=>(u(),_("div",{onClick:O(n=>ze(t),["stop"]),class:"item"},g(t.source_name),9,ut))),256))])]),_:1})])]),_:1},8,["visible"])])),[[r(Z),()=>{C.value=!1}]])])]),_:1}),a(p,{label:"时间",prop:"created_at_start"},{default:i(()=>[a(Te,{style:{width:"320px"},clearable:"",modelValue:b.value,"onUpdate:modelValue":e[11]||(e[11]=t=>b.value=t),type:"datetimerange","value-format":"YYYY-MM-DD HH:mm:ss","range-separator":" - ","start-placeholder":"开始日期","end-placeholder":"结束日期"},null,8,["modelValue"])]),_:1}),a(p,{label:"测试",prop:"test_cate_id"},{default:i(()=>[s("div",dt,[a(Ee,{onChange:e[12]||(e[12]=t=>r(o).test_cate_id=void 0),modelValue:V.value,"onUpdate:modelValue":e[13]||(e[13]=t=>V.value=t),placeholder:"测试类型",style:{display:"inline-block",width:"120px"}},{default:i(()=>[a(ue,{label:"流程测试",value:"W"}),a(ue,{label:"单元测试",value:"S"})]),_:1},8,["modelValue"]),a(De,{style:{width:"240px"},modelValue:r(o).test_cate_id,"onUpdate:modelValue":e[14]||(e[14]=t=>r(o).test_cate_id=t),filterable:"","check-strictly":"",props:{children:"children",label:"name",value:"id"},"node-key":"id",placeholder:V.value?"请选择":"请先选择测试类型","popper-class":"c-treebox","default-expand-all":!0,"check-on-click-node":!0,data:T.value.filter(t=>V.value&&t.tag==V.value)},{default:i(({node:t,data:n})=>[s("div",{title:n.name,class:"custom-tree-node"},[s("div",_t,[s("span",{class:"c-color radius",style:x("background-color:"+n.color)},null,4),v(g(n.name),1)])],8,ct)]),_:1},8,["modelValue","placeholder","data"])])]),_:1})]),_:1},8,["model"]),s("div",pt,[q((u(),_("span",{onClick:e[15]||(e[15]=t=>{R.value==0?R.value=67:R.value=0,E.value&&E.value.update()}),class:"c-search-openbtn"},e[22]||(e[22]=[s("span",{class:"iconfont icon-anniu-zhankai"},null,-1),s("span",{class:"opentext"},"展开",-1),s("span",{class:"closetext"},"收起",-1)]))),[[Ne]]),a(de,{onClick:e[16]||(e[16]=t=>M("init")),type:"primary"},{default:i(()=>e[23]||(e[23]=[v("查询")])),_:1}),a(de,{onClick:e[17]||(e[17]=t=>ee()),plain:""},{default:i(()=>e[24]||(e[24]=[v("重置")])),_:1})])]),s("div",ft,[s("div",vt,[a(Re,{ref_key:"tableRef",ref:E,onRowContextmenu:ye,"tooltip-effect":"light",border:"",data:r($),"max-height":r(ge).getters.innerHeight-198-R.value,style:{width:"100%"}},{empty:i(t=>[s("div",Et,[a(Pe,{type:"empzwssjg",width:"100",height:"100"}),e[27]||(e[27]=v("暂无数据~~ "))])]),default:i(()=>[a(y,{width:"100",prop:"id",label:"id"},{default:i(t=>[t.row.train_cates&&t.row.train_cates.length>0||t.row.test_cates&&t.row.test_cates.length>0?(u(),G(J,{key:0,placement:"top-end",width:200,trigger:"hover"},{reference:i(()=>[s("div",mt,[(u(!0),_(k,null,S(qe(t.row),(n,je)=>(u(),_("span",{class:pe(["dot",{on:n.xl}]),style:x("background-color: "+n.color+"; left: "+je*5+"px")},null,6))),256))])]),default:i(()=>[s("div",gt,[t.row.test_cates&&t.row.test_cates.some(n=>n&&n.tag!="S")?(u(),_("div",wt," 流程测试 ")):h("",!0),t.row.test_cates.length>0?(u(),_("div",ht,[(u(!0),_(k,null,S(t.row.test_cates.filter(n=>n&&n.tag!="S"),n=>(u(),_("div",yt,[s("span",{class:"c-color radius",style:x("background-color:"+n.color)},null,4),v(" "+g(n.name),1)]))),256))])):h("",!0),t.row.test_cates.some(n=>n&&n.tag=="S")?(u(),_("div",bt," 单元测试 ")):h("",!0),t.row.test_cates.length>0?(u(),_("div",xt,[(u(!0),_(k,null,S(t.row.test_cates.filter(n=>n&&n.tag=="S"),n=>(u(),_("div",kt,[s("span",{class:"c-color radius",style:x("background-color:"+n.color)},null,4),v(" "+g(n.name),1)]))),256))])):h("",!0),t.row.train_cates.length>0?(u(),_("div",Vt," 语料类型 ")):h("",!0),t.row.train_cates.length>0?(u(),_("div",Ct,[(u(!0),_(k,null,S(t.row.train_cates,n=>(u(),_("div",qt,[s("span",{class:"c-color",style:x("background-color:"+n.color)},null,4),v(" "+g(n.name),1)]))),256))])):h("",!0)])]),_:2},1024)):h("",!0),s("div",St,g(t.row.id),1)]),_:1}),a(y,{prop:"ai_run_id",width:"160",label:"用户id"}),a(y,{prop:"conversation_id",width:"160",label:"窗口id"}),a(y,{label:"输入"},{default:i(t=>[a(ve,{input:t.row.user_input,output:t.row.output.join(`
`),messages:t.row.human_messages},null,8,["input","output","messages"])]),_:1}),a(y,{width:"180",label:"输出"},{default:i(t=>[s("div",$t,[t.row.error_msg?(u(),G(Me,{key:0,effect:"light",placement:"right",content:"<div style=display:block;max-width:600px; class=c-danger>"+t.row.error_msg+"</div>","raw-content":""},{default:i(()=>e[25]||(e[25]=[s("span",{class:"c-danger iconfont icon-gantanhao1"},null,-1)])),_:2},1032,["content"])):h("",!0),t.row.human_messages&&t.row.human_messages.length>0?(u(),G(ve,{key:1,isShowOutput:!0,input:t.row.user_input,output:t.row.output.join(`
`),messages:t.row.human_messages},null,8,["input","output","messages"])):h("",!0)])]),_:1}),a(y,{width:"180",prop:"flow_name",label:"流程"},{default:i(t=>[s("div",zt,g(t.row.source_name),1),v(" "+g(t.row.flow_name),1)]),_:1}),a(y,{width:"180","show-overflow-tooltip":"",prop:"use_tools",label:"工具"}),a(y,{width:"100",align:"right",sortable:"",prop:"created_at",label:"耗时/s"},{default:i(t=>[v(g(t.row.elapsed_time),1)]),_:1}),a(y,{width:"80",align:"right",label:"评分"},{default:i(t=>[v(g(t.row.score||""),1)]),_:1}),a(y,{width:"160",align:"center",label:"时间"},{default:i(t=>[v(g(r(fe)(t.row.updated_at)||r(fe)(t.row.created_at)),1)]),_:1}),a(y,{width:"120",align:"center",label:"操作"},{default:i(t=>[s("div",{onClick:n=>he(t.row),class:"c-table-ibtn"},e[26]||(e[26]=[s("span",{class:"iconfont icon-liebiao-xiangqing"},null,-1),v(" 详情 ")]),8,Tt)]),_:1})]),_:1},8,["data","max-height"]),U.value>0?(u(),_("div",Dt,[a(Be,{"hide-on-single-page":!1,background:"","page-size":r(o).pagesize,"current-page":r(o).page,onSizeChange:e[18]||(e[18]=t=>{r(o).pagesize=t,r(o).page=Math.min(Math.ceil(U.value/r(o).pagesize),r(o).page),M()}),onCurrentChange:e[19]||(e[19]=t=>{r(o).page=t,E.value&&E.value.scrollTo(0,0),M()}),"page-sizes":[30,50,100,900],layout:"total,sizes,jumper,prev, pager, next",total:U.value},null,8,["page-size","current-page","total"])])):h("",!0)])])])),[[Oe]]),a(Je,{modelValue:Y.value,"onUpdate:modelValue":e[20]||(e[20]=t=>Y.value=t),onChange:we,data:le.value},null,8,["modelValue","data"]),q((u(),_("div",{class:"context-menu c-scroll-contain",style:x(I)},[s("div",{class:pe([{on:oe.value>600},"contmenubox"])},[s("div",{onMouseenter:e[21]||(e[21]=t=>{ae.value=!1,A.value=!0}),class:"citem"},[e[29]||(e[29]=v(" 添加到流程测试 ")),q(s("div",Ut,[a(Le,{ref:"ctreeSelecttest",data:T.value.filter(t=>t.tag!="S"),"node-key":"id","empty-text":" ","highlight-current":"","current-node-key":parseInt(m.type),"default-expand-all":"",onNodeClick:Se,"expand-on-click-node":!1},{default:i(({node:t,data:n})=>[s("div",{title:n.name,class:"custom-tree-node"},[s("div",{title:n.name,class:"item ellipsis"},[s("span",{class:"c-color radius",style:x("background-color:"+n.color)},null,4),v(g(n.name),1)],8,Rt)],8,Mt)]),_:1},8,["data","current-node-key"])],512),[[_e,A.value]])],32)],2)],4)),[[_e,H.value],[r(Z),xe]])],64)}}},Ft=Ie(Bt,[["__scopeId","data-v-3f1d8065"]]);export{Ft as default};
